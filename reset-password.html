<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Obnovit heslo | Maty√°≈° Holata</title>
<link rel="icon" type="image/png" href="mh-ico.png">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { font-family: 'Syne', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; width: 100%; }
body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #fff;
    --gap: 5em;
    --line: 1px;
    --color: rgba(255, 255, 255, 0.1);
    background-color: #000;
    background-image: linear-gradient(-90deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap)),
                      linear-gradient(0deg, transparent calc(var(--gap) - var(--line)), var(--color) calc(var(--gap) - var(--line) + 1px), var(--color) var(--gap));
    background-size: var(--gap) var(--gap);
    animation: moveGrid 10s linear infinite;
}
@keyframes moveGrid { from { background-position: 0 0; } to { background-position: 0 100%; } }

.reset-container {
    background: #0a0a0a;
    border: 2px solid #1a1a1a;
    border-radius: 12px;
    padding: 40px;
    width: 100%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 0 25px rgba(255, 255, 255, 0.05);
    animation: fadeIn 0.6s ease-in-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

h2 { font-weight: 700; font-size: 1.8rem; margin-bottom: 20px; }
.input-group { display: flex; flex-direction: column; margin-bottom: 20px; text-align: left; position: relative; }
.input-group label { margin-bottom: 8px; color: #ccc; display: flex; align-items: center; gap: 8px; }
.input-group input {
    padding: 12px;
    border-radius: 8px;
    border: 2px solid #161616;
    background-color: #000;
    color: #fff;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s;
}
.input-group input:focus { border-color: #fff; }

.show-password {
    position: absolute;
    right: 12px;
    top: 36px;
    cursor: pointer;
    font-size: 1.2rem;
    color: #ccc;
}

.reset-btn {
    width: 100%;
    background-color: #fff;
    color: #000;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}
.reset-btn:hover { background-color: #e6e6e6; }

.message {
    margin-top: 16px;
    font-size: 0.95rem;
    font-weight: 500;
    opacity: 0;
    transform: translateY(5px);
    transition: all 0.3s ease;
}
.message.show { opacity: 1; transform: translateY(0); }
.message.error { color: #ff4c4c; }
.message.success { color: #3dff85; }

#captchaContainer { display: flex; align-items: center; gap: 10px; margin-top: 10px; width: 100%; }
#captchaCanvas {
    border: 2px solid #161616;
    border-radius: 8px;
    background-color: #000;
    cursor: pointer;
    width: 100%;
    height: 100px;
}
#refreshCaptcha {
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    background-color: #1a1a1a;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
}
#refreshCaptcha:hover { background-color: #333; }

#captchaCheck {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: none;
    position: relative;
    flex-shrink: 0;
}
#captchaCheck::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 6px;
    height: 12px;
    border: solid #3dff85;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg) scale(0);
    transform-origin: center;
    transition: transform 0.4s ease;
}
#captchaCheck.show::after { transform: rotate(45deg) scale(1); }
</style>
</head>
<body>
<div class="reset-container">
    <h2>Obnovit heslo</h2>
    <div class="input-group" style="position: relative;">
        <label>Nov√© heslo</label>
        <input type="password" id="password" placeholder="Zadejte nov√© heslo">
        <span id="togglePassword" class="show-password">üëÅÔ∏è</span>
    </div>
    <div class="input-group">
        <label>Ovƒõ≈ôen√≠ captcha <div id="captchaCheck"></div></label>
        <div id="captchaContainer">
            <canvas id="captchaCanvas"></canvas>
            <button id="refreshCaptcha" type="button">‚Üª</button>
        </div>
    </div>
    <button class="reset-btn" id="resetBtn">Obnovit heslo</button>
    <div id="message" class="message">Captcha nen√≠ dokonƒçena</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-NtORtf_kX4baFqpELxgaXeFQ5I0AqKM",
  authDomain: "matyasholata-cz.firebaseapp.com",
  projectId: "matyasholata-cz",
  storageBucket: "matyasholata-cz.firebasestorage.app",
  messagingSenderId: "786028052149",
  appId: "1:786028052149:web:56005b616ea202c40208fc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const messageBox = document.getElementById("message");
const resetBtn = document.getElementById("resetBtn");
const togglePassword = document.getElementById("togglePassword");

const params = new URLSearchParams(window.location.search);
const oobCode = params.get('oobCode');

const captchaCanvas = document.getElementById("captchaCanvas");
const refreshBtn = document.getElementById("refreshCaptcha");
const captchaCheck = document.getElementById("captchaCheck");
const ctx = captchaCanvas.getContext("2d");

let particles = [], points = [], correctX, correctY, solved = false, circleOpacity = 1;
let width = captchaCanvas.clientWidth, height = captchaCanvas.clientHeight;

function showMessage(text, type) {
    messageBox.textContent = text;
    messageBox.className = "message " + type + " show";
}

function createParticles() {
    particles = [];
    for(let i=0;i<150;i++){
        particles.push({ x: Math.random()*width, y: Math.random()*height, r: Math.random()*2+1, speedX: (Math.random()-0.5)*0.5, speedY: (Math.random()-0.5)*0.5 });
    }
}
function createPoints() {
    points = [];
    const expW = width*1.5, expH = height*1.5, offsetX=(expW-width)/2, offsetY=(expH-height)/2;
    for(let i=0;i<30;i++){ points.push({ x: Math.random()*expW - offsetX, y: Math.random()*expH - offsetY, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5 }); }
}
function drawLines() {
    for(let i=0;i<points.length;i++){ for(let j=i+1;j<points.length;j++){
        const dx=points[i].x-points[j].x, dy=points[i].y-points[j].y, dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<120){
            if((points[i].x>=0 && points[i].x<=width && points[i].y>=0 && points[i].y<=height)||
               (points[j].x>=0 && points[j].x<=width && points[j].y>=0 && points[j].y<=height)){
                const alpha=1-dist/120;
                ctx.strokeStyle=`rgba(${Math.floor(255*alpha)},${Math.floor(255*alpha)},${Math.floor(255*alpha)},${alpha})`;
                ctx.lineWidth=1;
                ctx.beginPath();
                ctx.moveTo(points[i].x,points[i].y);
                ctx.lineTo(points[j].x,points[j].y);
                ctx.stroke();
            }
        }
    }}
}
function animateCaptcha(){
    width = captchaCanvas.clientWidth;
    height = captchaCanvas.clientHeight;
    ctx.clearRect(0,0,width,height);
    points.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; const expW = width*1.5, expH=height*1.5, offsetX=(expW-width)/2, offsetY=(expH-height)/2; if(p.x<-offsetX||p.x>width+offsetX) p.vx*=-1; if(p.y<-offsetY||p.y>height+offsetY) p.vy*=-1; });
    drawLines();
    particles.forEach(p=>{ p.x+=p.speedX; p.y+=p.speedY; if(p.x<0||p.x>width)p.speedX*=-1; if(p.y<0||p.y>height)p.speedY*=-1; ctx.fillStyle='rgba(200,200,200,0.2)'; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); });
    if(!solved || circleOpacity>0){
        ctx.save(); ctx.globalAlpha = 0.5*circleOpacity; ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=8; ctx.shadowOffsetX=2; ctx.shadowOffsetY=2;
        ctx.fillStyle='rgba(200,200,200,1)'; ctx.beginPath(); ctx.arc(correctX,correctY,12,0,Math.PI*2); ctx.fill();
        ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,0.8)'; ctx.stroke(); ctx.restore();
        if(solved) circleOpacity-=0.02;
    }
    requestAnimationFrame(animateCaptcha);
}
function drawCaptcha(){ width=captchaCanvas.clientWidth; height=captchaCanvas.clientHeight; captchaCanvas.width=width; captchaCanvas.height=height; solved=false; captchaCheck.style.display='none'; correctX=Math.random()*(width-40)+20; correctY=Math.random()*(height-40)+20; createParticles(); createPoints(); }

captchaCanvas.addEventListener("click", e=>{
    if(solved) return;
    const rect=captchaCanvas.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const distance=Math.hypot(x-correctX,y-correctY);
    if(distance<=12){ solved=true; captchaCheck.style.display='inline-block'; setTimeout(()=>{captchaCheck.classList.add('show');},50); showMessage("Captcha dokonƒçena","success"); }
    else { showMessage("≈†patnƒõ, kliknƒõte znovu","error"); }
});
refreshBtn.addEventListener("click",()=>{ if(!solved) drawCaptcha(); });

togglePassword.addEventListener('click', ()=>{
    const pw = document.getElementById('password');
    if(pw.type==='password'){ pw.type='text'; togglePassword.textContent='üôà'; }
    else{ pw.type='password'; togglePassword.textContent='üëÅÔ∏è'; }
});

drawCaptcha();
animateCaptcha();

resetBtn.addEventListener('click', async ()=>{
    const newPassword = document.getElementById('password').value;
    if(!newPassword){ showMessage("Zadejte nov√© heslo","error"); return; }
    if(!solved){ showMessage("Proveƒète captcha ovƒõ≈ôen√≠","error"); return; }
    try { await confirmPasswordReset(auth,oobCode,newPassword); showMessage("Heslo bylo √∫spƒõ≈°nƒõ zmƒõnƒõno!","success");
          setTimeout(()=>{ window.location.href="/demo"; },1200); }
    catch(e){ showMessage("Nastala chyba: "+e.message,"error"); }
});
</script>
</body>
</html>
